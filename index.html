<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.svg" type="image/svg" />
    <link rel="manifest" href="manifest.json" />
    <title>Coffee Bean Latte Compatibility Checker</title>

    <!-- OpenGraph Meta Tags -->
    <meta
      property="og:title"
      content="Coffee Bean Latte Compatibility Checker ‚òï"
    />
    <meta
      property="og:description"
      content="Not sure which coffee beans to use for lattes? Our tool helps you find the perfect coffee beans for milk-based drinks. Compare different coffee origins, processing methods, and roast levels to create the perfect latte at home or in your caf√©."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://latte-lovers.vercel.app" />
    <meta
      property="og:image"
      content="https://latte-lovers.vercel.app/og-image.png"
    />
    <meta
      property="og:image:alt"
      content="Coffee Bean Latte Compatibility Checker - Find the perfect coffee beans for your lattes"
    />

    <!-- Twitter Card Meta Tags -->
    <meta
      name="twitter:title"
      content="Coffee Bean Latte Compatibility Checker ‚òï"
    />
    <meta
      name="twitter:description"
      content="Not sure which coffee beans to use for lattes? Our tool helps you find the perfect coffee beans for milk-based drinks. Compare different coffee origins, processing methods, and roast levels to create the perfect latte at home or in your caf√©."
    />
    <meta
      name="twitter:image"
      content="https://latte-lovers.vercel.app/og-image.png"
    />

    <!-- Additional Meta Tags -->
    <meta
      name="description"
      content="Not sure which coffee beans to use for lattes? Our tool helps you find the perfect coffee beans for milk-based drinks. Compare different coffee origins, processing methods, and roast levels to create the perfect latte at home or in your caf√©."
    />
    <meta
      name="keywords"
      content="best coffee for lattes, coffee beans for milk drinks, which coffee is good for lattes, coffee bean guide, coffee selection guide, coffee and milk compatibility, best coffee beans for milk, coffee bean recommendations, coffee brewing guide, barista tips, coffee bean characteristics, coffee flavor guide, how to choose coffee beans, coffee bean comparison, coffee bean selection tool, coffee bean compatibility, coffee bean guide for lattes, best coffee for milk drinks, coffee bean recommendations for lattes, coffee bean selection for cafes, coffee bean guide for baristas, coffee bean characteristics guide, coffee bean flavor profile, coffee bean selection for milk drinks, coffee bean guide for home brewing"
    />
    <meta name="author" content="Lonli-Lokli" />

    <!-- Additional SEO Meta Tags -->
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="revisit-after" content="7 days" />
    <meta name="rating" content="general" />
    <meta name="distribution" content="global" />
    <meta name="category" content="Coffee Tools" />
    <meta name="coverage" content="Worldwide" />
    <meta name="target" content="all" />
    <meta name="HandheldFriendly" content="true" />
    <meta name="MobileOptimized" content="width" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Latte Lovers" />
    <link rel="apple-touch-icon" href="192x192.png" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>
            <span class="coffee-emoji">‚òï</span>Coffee Bean Latte Compatibility
          </h1>
          <p>Find the perfect coffee beans for your milk-based drinks</p>
        </div>
        <div class="header-buttons">
          <button class="theme-toggle" title="Toggle theme">
            <span id="themeIcon">‚òÄÔ∏è</span>
          </button>
          <a href="#" class="header-btn" id="contactBtn">üìß Contact</a>
          <a
            href="https://buymeacoffee.com/lonlilokliV"
            class="header-btn"
            target="_blank"
            >‚òï Buy Me a Coffee</a
          >
          <button id="installPWA" class="header-btn hidden">
            üì± Save to Phone
          </button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <nav class="tab-navigation">
        <button class="tab-btn active" data-tab="checker">
          <span class="tab-icon">üîç</span>
          <span class="tab-label">Coffee Checker</span>
        </button>
        <button class="tab-btn" data-tab="top">
          <span class="tab-icon">üîù</span>
          <span class="tab-label">Leaders</span>
        </button>
      </nav>

      <!-- Content Container -->
      <div id="content-container" class="content-container">
        <div class="loading-spinner"></div>
      </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Get in Touch</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form action="https://formsubmit.co/lonli.lokli@gmail.com" method="POST">
            <input type="hidden" name="_subject" value="New message from Latte Coffee Checker" />
            <input type="hidden" name="_captcha" value="false" />
            <input type="hidden" name="_next" value="#contact-success" />

            <div class="modal-form-group">
              <label for="contactName">Name *</label>
              <input type="text" id="contactName" name="name" required />
            </div>

            <div class="modal-form-group">
              <label for="contactEmail">Email *</label>
              <input type="email" id="contactEmail" name="email" required />
            </div>

            <div class="modal-form-group">
              <label for="contactMessage">Message *</label>
              <textarea
                id="contactMessage"
                name="message"
                placeholder="Tell us about your coffee experience or suggestions..."
                required
              ></textarea>
            </div>

            <button type="submit" class="modal-submit-btn">Send Message</button>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        toggleBlendInputs,
        validateBlend,
        checkCoffee,
        toggleTheme,
        openContactModal,
        closeContactModal,
        coffeeProfiles,
        processingMethods,
        generateAndRankLeaders,
        roastLevelEffects,
      } from "./script.mjs";

      // Content cache
      const contentCache = new Map();
      let currentTab = 'checker';

      // Initialize country options
      function initializeCountryOptions() {
        const countrySelects = ["country", "blend1Country", "blend2Country"];
        const countries = Object.keys(coffeeProfiles).sort();

        countrySelects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (select) {
            countries.forEach((country) => {
              const option = document.createElement("option");
              option.value = country;
              option.textContent = country
                .split("-")
                .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                .join(" ");
              select.appendChild(option);
            });
          }
        });
      }

      // Initialize processing options
      function initializeProcessingOptions() {
        const processingSelect = document.getElementById("processing");
        if (processingSelect) {
          const methods = Object.entries(processingMethods);

          methods.forEach(([value, { displayName }]) => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = displayName;
            if (value === "washed") {
              option.selected = true;
            }
            processingSelect.appendChild(option);
          });
        }
      }

      // Load tab content
      async function loadTabContent(tabName) {
        const contentContainer = document.getElementById('content-container');
        if (!contentContainer) {
          console.error('Content container not found');
          return;
        }

        // Create loading spinner if it doesn't exist
        let spinner = contentContainer.querySelector('.loading-spinner');
        if (!spinner) {
          spinner = document.createElement('div');
          spinner.className = 'loading-spinner';
          contentContainer.appendChild(spinner);
        }
        
        // Show loading spinner
        spinner.classList.remove('hidden');
        
        try {
          // Check cache first
          if (contentCache.has(tabName)) {
            contentContainer.innerHTML = contentCache.get(tabName);
            // Re-add spinner after setting innerHTML
            spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            contentContainer.appendChild(spinner);
          } else {
            const response = await fetch(`${tabName}.html`);
            if (!response.ok) throw new Error('Failed to load content');
            const content = await response.text();
            contentContainer.innerHTML = content;
            contentCache.set(tabName, content);
            // Re-add spinner after setting innerHTML
            spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            contentContainer.appendChild(spinner);
          }

          // Initialize form elements after content is loaded (only for checker tab)
          if (tabName === 'checker') {
            initializeCountryOptions();
            initializeProcessingOptions();

            // Add event listeners for the loaded content
            const coffeeTypeSelect = document.getElementById('coffeeType');
            if (coffeeTypeSelect) {
              coffeeTypeSelect.addEventListener('change', toggleBlendInputs);
            }

            const blend1Percent = document.getElementById('blend1Percent');
            const blend2Percent = document.getElementById('blend2Percent');
            if (blend1Percent && blend2Percent) {
              blend1Percent.addEventListener('input', validateBlend);
              blend2Percent.addEventListener('input', validateBlend);
            }

            const checkBtn = document.querySelector('.check-btn');
            if (checkBtn) {
              checkBtn.addEventListener('click', checkCoffee);
            }
          } else if (tabName === 'top') {
              // Populate leaders table
              const leaders = generateAndRankLeaders(coffeeProfiles, processingMethods, roastLevelEffects);
              const tableBody = contentContainer.querySelector('.leaders-table .table-body');

              if (tableBody) {
                  tableBody.innerHTML = ''; // Clear existing content
                  const topLeaders = leaders.slice(0, 10); // Display top 10

                  topLeaders.forEach((leader, index) => {
                      const tableRow = document.createElement('tr');
                      tableRow.classList.add('table-row');
                      tableRow.innerHTML = `
                          <td class="table-cell table-rank">${index + 1}</td>
                          <td class="table-cell">${leader.country}</td>
                          <td class="table-cell" title="${leader.processingDisplayName}"><span class="processing-abbreviation">${leader.processingAbbreviation}</span></td>
                          <td class="table-cell">${leader.roast}</td>
                          <td class="table-cell table-score ${leader.grade}">${leader.score}/10</td>
                      `;
                      tableBody.appendChild(tableRow);
                  });
              }

              // Add click listener for processing tooltips on mobile
              const tableBodyMobile = contentContainer.querySelector('.leaders-table .table-body');
              if (tableBodyMobile) {
                tableBodyMobile.addEventListener('click', (event) => {
                  const clickedCell = event.target.closest('td');
                  if (clickedCell && clickedCell.classList.contains('table-cell') && clickedCell.textContent !== 'Rank' && clickedCell.textContent !== 'Country' && clickedCell.textContent !== 'Roast' && clickedCell.textContent !== 'Score') { // Check if it's a data cell (not a header) and not Rank, Country, Roast, or Score
                      // Check if it's the processing cell (using index or content check)
                      const row = clickedCell.parentElement;
                      const cells = Array.from(row.children);
                      const processingCellIndex = 2; // Processing is the 3rd column (index 2)

                      if (clickedCell === cells[processingCellIndex]) {

                          const tooltipText = clickedCell.title;
                          if (tooltipText) {
                              // Remove any existing tooltips
                              document.querySelectorAll('.processing-tooltip').forEach(tooltip => tooltip.remove());

                              const tooltip = document.createElement('div');
                              tooltip.classList.add('processing-tooltip');
                              tooltip.textContent = tooltipText;

                              // Basic tooltip styling (you can add more in CSS)
                              tooltip.style.position = 'absolute';
                              tooltip.style.background = 'var(--surface-color)';
                              tooltip.style.color = 'var(--text-color)';
                              tooltip.style.border = '1px solid var(--border-color)';
                              tooltip.style.padding = '5px';
                              tooltip.style.borderRadius = '5px';
                              tooltip.style.zIndex = '1000';
                              tooltip.style.top = `${clickedCell.getBoundingClientRect().bottom + window.scrollY + 5}px`;
                              tooltip.style.left = `${clickedCell.getBoundingClientRect().left + window.scrollX}px`;
                              tooltip.style.maxWidth = '200px';
                              tooltip.style.whiteSpace = 'normal';
                              tooltip.style.wordWrap = 'break-word';

                              document.body.appendChild(tooltip);

                              // Hide tooltip on click outside
                              const dismissTooltip = (e) => {
                                if (!tooltip.contains(e.target) && e.target !== clickedCell) {
                                  tooltip.remove();
                                  document.removeEventListener('click', dismissTooltip);
                                }
                              };
                              document.addEventListener('click', dismissTooltip);

                               // Optional: Hide tooltip after a few seconds
                              // setTimeout(() => {
                              //     if(tooltip.parentElement) tooltip.remove();
                              //     document.removeEventListener('click', dismissTooltip);
                              // }, 5000);
                          }
                      }
                  }
                });
              }
          }

        } catch (error) {
          console.error('Error loading tab content:', error);
          contentContainer.innerHTML = '<div class="error">Failed to load content. Please try again.</div>';
        } finally {
          // Hide loading spinner
          spinner = contentContainer.querySelector('.loading-spinner');
          if (spinner) {
            spinner.classList.add('hidden');
          }
        }
      }

      // Handle tab switching
      function switchTab(tabName) {
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tabName);
        });

        // Update URL hash
        window.location.hash = tabName;
        currentTab = tabName;

        // Load tab content
        loadTabContent(tabName);
      }

      // Service Worker registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("/sw.js")
            .then(function (registration) {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            })
            .catch(function (error) {
              console.log("ServiceWorker registration failed: ", error);
            });
        });
      }

      // Initialize when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        // Add tab click handlers
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Handle hash changes
        window.addEventListener('hashchange', () => {
          const tabName = window.location.hash.slice(1) || 'checker';
          switchTab(tabName);
        });

        // Handle initial load
        const initialTab = window.location.hash.slice(1) || 'checker';
        switchTab(initialTab);

        // Theme toggle
        document.querySelector(".theme-toggle").addEventListener("click", toggleTheme);

        // Contact modal handlers
        document.getElementById("contactBtn").addEventListener("click", openContactModal);
        document.querySelector(".close").addEventListener("click", closeContactModal);
        window.addEventListener("click", (event) => {
          const modal = document.getElementById("contactModal");
          if (event.target === modal) {
            closeContactModal();
          }
        });

        // PWA Installation
        let deferredPrompt;
        const installButton = document.getElementById("installPWA");

        if (window.matchMedia("(display-mode: standalone)").matches) {
          installButton.classList.add("hidden");
        }

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
          installButton.classList.remove("hidden");
          installButton.addEventListener("click", () => {
            alert(
              'To install this app on your device, tap the Share button and then "Add to Home Screen"'
            );
          });
        } else {
          window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove("hidden");
          });

          installButton.addEventListener("click", async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installButton.classList.add("hidden");
          });
        }
      });
    </script>
  </body>
</html>
